<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>FreeSwap Protocol - FreeSwap DEX Protocol</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">FreeSwap DEX Protocol</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Introduction</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">FreeSwap Protocol</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Downloads <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../FreeSwap_en.pdf" class="dropdown-item">White Paper</a>
</li>
                                    
<li>
    <a href="../FreeSwap_cn.pdf" class="dropdown-item">White Paper (CN)</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Others <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="https://ldru.github.io/FortSwap/" class="dropdown-item">Chinese</a>
</li>
                                    
<li>
    <a href="../contact/" class="dropdown-item">Contact</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href=".." class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../FreeSwap_en.pdf" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#freeswap-decentralized-exchange-protocol" class="nav-link">FreeSwap Decentralized Exchange Protocol</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#abstract" class="nav-link">Abstract</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#0-introduction" class="nav-link">0 Introduction</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#1-basics-of-liquidity-pool" class="nav-link">1 Basics of Liquidity Pool</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2-freeswap-exchange-protocol" class="nav-link">2 FreeSwap exchange protocol</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#3-freeswap-arbitrage-analysis" class="nav-link">3 FreeSwap arbitrage analysis</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#4-freeswap-protocol-conclusion" class="nav-link">4 FreeSwap protocol conclusion</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#references" class="nav-link">References</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="freeswap-decentralized-exchange-protocol">FreeSwap Decentralized Exchange Protocol</h1>
<div class="toc">
<ul>
<li><a href="#freeswap-decentralized-exchange-protocol">FreeSwap Decentralized Exchange Protocol</a><ul>
<li><a href="#abstract">Abstract</a></li>
<li><a href="#0-introduction">0 Introduction</a></li>
<li><a href="#1-basics-of-liquidity-pool">1 Basics of Liquidity Pool</a><ul>
<li><a href="#11-swap-pair-definition">1.1 Swap pair definition</a></li>
<li><a href="#12-constant-product-invariant">1.2 Constant-product invariant</a></li>
<li><a href="#13-trade-arbitrage">1.3 Trade arbitrage</a></li>
<li><a href="#14-impermanent-loss">1.4 Impermanent loss</a></li>
</ul>
</li>
<li><a href="#2-freeswap-exchange-protocol">2 FreeSwap exchange protocol</a><ul>
<li><a href="#21-freetswap-protocol-goal">2.1 FreetSwap protocol goal</a></li>
<li><a href="#22-freeswap-trade-pair-setup">2.2 FreeSwap trade pair setup</a></li>
<li><a href="#23-freetswap-token-exchange">2.3 FreetSwap token exchange</a></li>
<li><a href="#24-freeswap-exchange-arbitrage">2.4 FreeSwap exchange arbitrage</a></li>
</ul>
</li>
<li><a href="#3-freeswap-arbitrage-analysis">3 FreeSwap arbitrage analysis</a><ul>
<li><a href="#31-freeswap-arbitrage-analysis">3.1 FreeSwap arbitrage analysis</a></li>
<li><a href="#32-freeswap-arbitrage-profit">3.2 FreeSwap arbitrage profit</a></li>
<li><a href="#33-equivalent-transaction-fee-rate">3.3 Equivalent transaction fee rate</a></li>
<li><a href="#34-not-applicable-exchanges">3.4 Not applicable exchanges</a></li>
</ul>
</li>
<li><a href="#4-freeswap-protocol-conclusion">4 FreeSwap protocol conclusion</a></li>
<li><a href="#references">References</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="abstract">Abstract</h2>
<p>FreeSwap protocol is a decentralized exchange protocol that does not charge any exchange fees. Based on the formula &ldquo;constant-product invariant&rdquo;, Freeswap creates two one-way-swap sub-pools for each pair of tokens. As the swap going, when the token price deviation in the two sub-pools reaches a certain extent, the sub-pools carry out arbitrage operation with each other. This arbitrage operation can rebalance the token prices in the sub-pools and make profits for liquidity providers. This paper mainly describes the Freeswap arbitrage mechanism and its basic rules, expounds its win-win characteristics, and evaluates the arbitrage profit level quantitatively through a theoretical model. It is shown that Freeswap can achieve the arbitrage profit equivalent to 2.488 ‰ swap fee while arbitraging at sub-pool price deviation of 1%.</p>
<h2 id="0-introduction">0 Introduction</h2>
<p>In 2020, &ldquo;constant-product invariant&rdquo; formula <script type="math/tex">^{[1]}</script> made a great success in decentralized exchanges. This formula is extremely concise, but it can automatically determine the token price in the liquidity pools. DEXs based on the this formula, such as Uniswap<script type="math/tex">^{[2][3]}</script> and SushiSwap, can provide competitive swapping liquidity and trading depth, and attract a large number of cryptocurrency investors.</p>
<p>However, in addition to paying the gas fee of blockchain network, DEX transactions also need to pay a certain percentage of enchange fees, which is some higher than centralized exchanges. The purpose of Freeswap protocol is to design a completely free exchange protocol that does not require to pay any exchange fees. It is expected that by removing exchange fees, more users can be attracted to join DEXs and leave centralized exchanges.</p>
<p>To solve the problem of &ldquo;front running attack&rdquo;, Vitalik Buterin once proposed to set up two one-way trading sides for a token pair<script type="math/tex">^{[4]}</script>. Freeswap protocol refines his proposal and defines the implementation details. Since the two onw-way trading pools can only exchange tokens in one direction, this will inevitably lead to the reverse deviation of token prices between two trading pools. This deviation can not only stop &ldquo;front-running attack&rdquo; of miners, but also provide a way to make profits for liquidity providers. Freeswap protocol makes full use of the arbitrage opportunities generated by the price deviations between the two sub-pools to provide returns to liquidity providers, and further, to serve the exchange users totally with no trade fee.</p>
<h2 id="1-basics-of-liquidity-pool">1 Basics of Liquidity Pool</h2>
<h3 id="11-swap-pair-definition">1.1 Swap pair definition</h3>
<p>The Swap pair consists of two different tokens that can be exchanged, represented by <script type="math/tex">Token A</script> and <script type="math/tex">Token B</script>, respectively. When creating a swap pair, the user needs to deposit corresponding number of <script type="math/tex">Token A</script> and <script type="math/tex">Token B</script> with equal value according to the actual market price. If the price differs from the market price, the pair will be arbitraged and the creator will suffer a loss.</p>
<p>Assuming <script type="math/tex">P_{A}</script> and <script type="math/tex">P_{B}</script> are respectively the price of <script type="math/tex">Token A</script> and <script type="math/tex">Token B</script> in any legal currency, <script type="math/tex">P_{A\rightarrow B}</script> is defined as the price exchanging <script type="math/tex">token A </script> for <script type="math/tex">Token B</script>, which is the amount of <script type="math/tex">Token B</script> equivalent to <script type="math/tex">1\ Token A</script>:</p>
<p>
<script type="math/tex; mode=display">P_{A \rightarrow B} = \frac{P_A}{P_B} \tag{1.1.1}</script>
</p>
<p>Similarly, define <script type="math/tex">P_{B \rightarrow A}</script>, which is the price at which <script type="math/tex">Token B</script> is traded to <script type="math/tex">Token A</script>:</p>
<p>
<script type="math/tex; mode=display">P_{B \rightarrow A} = \frac{P_B}{P_A} \tag{1.1.2}</script>
</p>
<p>In theory, without considering trading costs, the following relationship exists:</p>
<p>
<script type="math/tex; mode=display">P_{A \rightarrow B} * P_{B \rightarrow A} = 1 \tag{1.1.3}</script>
</p>
<p>Assuming <script type="math/tex">N_A</script> and <script type="math/tex">N_B</script> are the quantities of two digital assets <script type="math/tex">Token A</script> and <script type="math/tex">Token B</script> at any time within the trade pair, we express the trade pair as:</p>
<p>
<script type="math/tex; mode=display">(N_A \ | \ N_B) \tag{1.1.4}</script>
</p>
<p>The trade pair always assume two internal tokens have equal market values all the time, and so, following formula are equivalent:</p>
<p>
<script type="math/tex; mode=display">N_A * P_{A} = N_B * P_{B} \tag{1.1.5}</script>
</p>
<p>
<script type="math/tex; mode=display">N_A = N_B * P_{B \rightarrow A} \tag{1.1.6}</script>
</p>
<p>
<script type="math/tex; mode=display">N_B = N_A * P_{A \rightarrow B} \tag{1.1.7}</script>
</p>
<p>
<script type="math/tex; mode=display">P_{A \rightarrow B} = \frac{N_B}{N_A} \tag{1.1.8}</script>
</p>
<p>
<script type="math/tex; mode=display">P_{B \rightarrow A} = \frac{N_A}{N_B} \tag{1.1.9}</script>
</p>
<h3 id="12-constant-product-invariant">1.2 Constant-product invariant</h3>
<p>While performing token exchange, since the external prices of <script type="math/tex">Token A</script> and <script type="math/tex">Token B</script> cannot be easily obtained, it is needed to design a mechanism to determine the exchange ratio between <script type="math/tex">Token A</script> and <script type="math/tex">Token B</script>. The DEXs of Automated Market Maker (AMM) type uses the &ldquo;constant-product invariant&rdquo; formula <script type="math/tex">^{[1]}</script> to determine the change of the number of tokens in the trading pool before and after the exchange, also the amount of tokens traded in and out accordingly.</p>
<p>For the pair of <script type="math/tex">(N_A \ | \ N_B)</script>, &ldquo;constant-product invariant&rdquo; formula is represented as:</p>
<p>
<script type="math/tex; mode=display">N_A * N_B=K \tag{1.2.1}</script>
</p>
<p>In this formula, the value of <script type="math/tex">K</script> changes only when the users deposit tokens to, or remove tokens from the trading pair, and alway remains constant during the trading process.</p>
<p>Suppose in a exchange oparetion, the user trades <script type="math/tex">Token A</script> for <script type="math/tex">Token B</script>, and the input amount of <script type="math/tex">Token A</script> is <script type="math/tex">\mathrm{\Delta}_{A}</script>, the output amount of <script type="math/tex">Token B</script> is <script type="math/tex">\mathrm{\Delta}_{B}</script>. ( &ldquo;Trade in&rdquo; and &ldquo;trade out&rdquo; here after are from the point of liquidity pool, if from the point of users, the relationship &ldquo;trade in&rdquo; and &ldquo;trade out&rdquo; is completely opposite). According to the &ldquo;constant-product invariant&rdquo; formula, there are:</p>
<p>
<script type="math/tex; mode=display"> ( N_A + \mathrm{\Delta}_A ) * (N_B - \mathrm{\Delta}_B ) = ( N_A * N_B )  \tag{1.2.2}</script>
</p>
<p>
<script type="math/tex; mode=display">\mathrm{\Delta}_B = \frac{\mathrm{\Delta}_A}{N_A + \mathrm{\Delta}_A} * N_B \tag{1.2.3}</script>
</p>
<p>It can be seen that there are three different prices here, before the trade, after the trade, and happend during the trade.</p>
<p>The token price of the pool before the trade (expressed as <script type="math/tex">P_{A \rightarrow B}^{0}</script>):</p>
<p>
<script type="math/tex; mode=display">P_{A \rightarrow B}^{0} = \frac{N_B}{N_A} \tag{1.2.4}</script>
</p>
<p>The actual token price taken in the trade (represented as <script type="math/tex">P_{A \rightarrow B}^{1}</script>) is:</p>
<p>
<script type="math/tex; mode=display">P_{A \rightarrow B}^{1} = \frac{\mathrm{\Delta}_B}{\mathrm{\Delta}_A} = \frac{N_B}{N_A + \mathrm{\Delta}_A} \tag{1.2.5}</script>
</p>
<p>The token price after the trade finished (represented as <script type="math/tex">P_{A \rightarrow B}^{2}</script>) is:</p>
<p>
<script type="math/tex; mode=display">P_{A \rightarrow B}^{2} = \frac{N_B - \mathrm{\Delta}_B}{N_A +  \mathrm{\Delta}_A} \tag{1.2.6}</script>
</p>
<p>Obviously:</p>
<p>
<script type="math/tex; mode=display">P_{A \rightarrow B}^{0} > P_{A \rightarrow B}^{1} > P_{A \rightarrow B}^{2} \tag{1.2.7}</script>
</p>
<p>It means, the price of trade-in token <script type="math/tex">Token A</script> relative to the trade-out token <script type="math/tex">Token B</script> has slipped after the trade has finised. The price of <script type="math/tex">Token A</script> in the pair before the trade starts is higher than the actual price the trade adopts, and the actual price the trade adopts is higher than the price of <script type="math/tex">Token A</script> in the pair after the trade is completed. That is, after the token trade is completed, the price of <script type="math/tex">Token A</script> relative to <script type="math/tex">Token B</script> in the pair has fallen, and accordingly, the relative price of <script type="math/tex">Token B</script> has risen.</p>
<h3 id="13-trade-arbitrage">1.3 Trade arbitrage</h3>
<p>The exchange operation happens at the moment the transaction block is confirmed on the blockchain. The external prices of <script type="math/tex">Token A</script> and <script type="math/tex">Token B</script> will not change at that moment. Due to the constraint of &ldquo;constant-product invariant&rdquo;, the token price will slide within the exchange, which will cause users to suffer a certain marginal exchange loss. The exchange loss in the amount of <script type="math/tex">Token B</script> is calculated as follows:</p>
<p>
<script type="math/tex; mode=display">\begin{aligned} Lost_{A \rightarrow B} &= \mathrm{\Delta}_A * \frac{N_B}{N_A} - \mathrm{\Delta}_A * \frac{N_B}{N_A + \mathrm{\Delta}_A} \\[3mm]
&= \mathrm{\Delta}_A * \frac{N_B}{N_A} \Large{/} \normalsize ( 1 + \frac{N_A} {\mathrm{\Delta}_{A}} ) \end{aligned} \tag{1.3.1}</script>
</p>
<p>It can be seen that the greater the ratio <script type="math/tex">(\mathrm{\Delta}_{A} / N_A)</script> the user trade <script type="math/tex">Token A</script> into the pool, the greater the exchange loss it will suffer.</p>
<p>After the exchange is completed, if another user performs reverse exchange, according to the &ldquo;constant-product invariant&rdquo; formula, he/she only needs to pay <script type="math/tex">Token B</script> in the amount of <script type="math/tex">\mathrm{\Delta}_B</script>, and can get <script type="math/tex">Token A</script> of <script type="math/tex">\mathrm{\Delta}_A</script>. After this reverse exchange, the asset price in the pool will return to the initial price <script type="math/tex">P_{A \rightarrow B} = N_B/N_A</script>. That is, this user completes the exchange at the higher <script type="math/tex">Token B</script> to <script type="math/tex">Token A</script> price, and realizes the arbitrage of the previous user&rsquo;s exchange loss, the arbitrage profit is equal to the previous user&rsquo;s exchange loss.</p>
<h3 id="14-impermanent-loss">1.4 Impermanent loss</h3>
<p>When providing liquidity, the provider needs to inject into the trading pool two tokens of corresponding amounts with the same total value. With the trade on going, the number of tokens corresponding to the user&rsquo;s liquidity will change. Assuming that the user’s initial investment of <script type="math/tex">Token A</script> is <script type="math/tex">X_{A}</script>, when the user exits liquidity, if the market price of <script type="math/tex">Token A</script> rises relative to <script type="math/tex">Token B</script>, then <script type="math/tex">{X'}_{A}</script>，the amount of <script type="math/tex">Token A</script> that the user can get from the pool may be less than <script type="math/tex">X_{A}</script>. If the liquidity service income obtained by providing liquidity are not enough to compensate for the loss caused by the decrease in the amount of <script type="math/tex">Token A</script>, in this case, the liquidity provider will suffer losses relative to simply holding <script type="math/tex">Token A</script> and <script type="math/tex">Token B</script> instead of providing liquidity services. In fact, no matter whether the price of <script type="math/tex">Token A</script> and <script type="math/tex">Token B</script> goes up or down, as long as their price deviates from the time providing liquidity, the user will suffer losses. The amount of the loss is completely determined by the market price variation, beyond any user&rsquo;s control, which is also called &ldquo;Impermanent Loss&rdquo; <script type="math/tex">^{[5]}</script>.</p>
<p>Taking <script type="math/tex">Token B</script> as the price benchmark, following quantitative analysis of impermanent loss is conducted without considering the exchange fee income. Assuming that the initial number of tokens that the user puts into the trade pair is <script type="math/tex">(X_A|Y_B)</script>, the price of <script type="math/tex">Token A</script> relative to <script type="math/tex">Token B</script> is <script type="math/tex">P_1</script>, and at the end, the number of tokens that the user withdraws from the trade pair is <script type="math/tex">(X'_A|Y'_B)</script>, and the price of <script type="math/tex">Token A</script> relative to <script type="math/tex">Token B</script> is <script type="math/tex">P_2</script>, if the user does not provide liquidity for the trading pool, but simply holds <script type="math/tex">(X_A|Y_B)</script> tokens, the final value is:</p>
<p>
<script type="math/tex; mode=display">V_1=X_A*P_2+Y_B \tag{1.4.1}</script>
</p>
<p>Since the user provides liquidity for the trading pool, the actual value of <script type="math/tex">(X'_{A}|Y'_{B})</script> tokens is:</p>
<p>
<script type="math/tex; mode=display">V_2=X'_A*P_2+Y'_B \tag{1.4.2}</script>
</p>
<p>Considering:</p>
<p>
<script type="math/tex; mode=display">\left\{ \begin{matrix} \begin{aligned}
X_A * Y_B &= X'_A * Y'_B \\
P_1 &= Y_B / X_A \\
P_2 &= Y'_B / X'_A \\
\end{aligned} \end{matrix} \right. \tag{1.4.3}</script>
</p>
<p>Then there is <script type="math/tex">^{[6]}</script>:</p>
<p>
<script type="math/tex; mode=display">\begin{aligned} \frac{V_2}{V_1} &= \frac{\ 2\sqrt{P_1*P_2}\ }{P_1+P_2} \\[3mm]
&= \sqrt{\frac{4P_{1}P_{2}}{( P_{1} - P_{2} )^{2} + 4P_{1}P_{2}}} \leq 1 \end{aligned} \tag{1.4.4}</script>
</p>
<p>So, as long as <script type="math/tex">P_1 \neq P_2</script>, <script type="math/tex">V_2</script> is always less than <script type="math/tex">V_1</script>, that is to say, the users&rsquo;s total token value denominated in <script type="math/tex">Token B</script> must be reduced compared to simply holding two tokens. Similarly the total token value denominated in <script type="math/tex">Token A</script> must also be reduced compared to simply holding two tokens. Therefore, the so-called &ldquo;Impermanent Loss&rdquo; is actually a permanent loss that is bound to occur, only the amount of loss may change with the price ratio.</p>
<h2 id="2-freeswap-exchange-protocol">2 FreeSwap exchange protocol</h2>
<h3 id="21-freetswap-protocol-goal">2.1 FreetSwap protocol goal</h3>
<p>The goal of freeswap protocol is to implement a decentralized exchange protocol with no trade fees at all. The &ldquo;constant-product invariant&rdquo; mechanism inevitably leads to token price slippage, from which Freeswap could make profits for liquidity provider by arbitraging automatically.</p>
<h3 id="22-freeswap-trade-pair-setup">2.2 FreeSwap trade pair setup</h3>
<p>FreeSwap trade protocol sets up two independent one-way sub-pools for the token pair <script type="math/tex">(Token_A|Token_B)</script>, expressed as:</p>
<p>
<script type="math/tex; mode=display">( N_{AA} | N_B)\ || \ (N_A | N_{BB} ) \tag{2.2.1} </script>
</p>
<p>Where, the sub-pool <script type="math/tex">(N_{AA}|N_B)</script> (called as <script type="math/tex">A</script> sub-pool, or <script type="math/tex">A</script> pool hereinafter) can trade in <script type="math/tex">Token A</script>, trade out <script type="math/tex">Token B</script>, <script type="math/tex">N_{AA}</script> is the number of <script type="math/tex">Token A</script>, and <script type="math/tex">N_B</script> is the number of <script type="math/tex">Token B</script> in <script type="math/tex">A</script> pool.</p>
<p>The sub-pool <script type="math/tex">(N_A|N_{BB})</script> (called as <script type="math/tex">B</script> sub-pool, or <script type="math/tex">B</script> pool hereinafter) can trade in <script type="math/tex">Token B</script>, trade out <script type="math/tex">Token A</script>, <script type="math/tex">N_{BB}</script> is the number of <script type="math/tex">Token B</script>, and <script type="math/tex">N_A</script> is the number of <script type="math/tex">Token A</script> in <script type="math/tex">B</script> pool.</p>
<p>When the liquidity provider adds tokens into the trading pool, he can specify which sub-pool to add, or he can add into both the sub-pools at the same time with specified ratio.</p>
<h3 id="23-freetswap-token-exchange">2.3 FreetSwap token exchange</h3>
<p>When the user trades <script type="math/tex">Token A</script> and <script type="math/tex">Token B</script> with the trading pool, there are two opposite trading operations, one is to trade in <script type="math/tex">Token A</script>, and trade out <script type="math/tex">Token B</script>; the other is to trade in <script type="math/tex">Token B</script>, and trade out <script type="math/tex">Token A</script>. Here, &ldquo;trade in&rdquo; and &ldquo;trade out&rdquo; are relative to the trading pool.</p>
<p>If the user trades <script type="math/tex">Token A</script> for <script type="math/tex">Token B</script>, FreeSwap will pass this trade to <script type="math/tex">A</script> pool, the <script type="math/tex">(N_{AA}|N_B )</script> sub-pool to process. The <script type="math/tex">A</script> pool always trades in <script type="math/tex">Token A</script> and swap out <script type="math/tex">Token B</script>, so the number of <script type="math/tex">N_{AA}</script> always goes up, and the number of <script type="math/tex">N_B</script> always goes down, which will lead to the monotonous decrease of <script type="math/tex">token A</script> price denominated by <script type="math/tex">Token B</script>, and finally resulting <script type="math/tex">Token A</script> price deviating from actual market price. </p>
<p>Similarly, if the user trade in <script type="math/tex">token B</script> for <script type="math/tex">token A</script>, <script type="math/tex">B</script> pool will handle this trade. <script type="math/tex">B</script> pool always trades in <script type="math/tex">token B</script>, and swaps out <script type="math/tex">token A</script>, so the amount of <script type="math/tex">N_{BB}</script> will keep rising, and the amount of <script type="math/tex">N_A</script> keep falling, which will also cause that <script type="math/tex">B</script> price denominated in <script type="math/tex">Token A</script> decreases monotonically and eventually deviates from the actual market price.</p>
<p>The sub-pool <script type="math/tex">(N_{AA}|N_B)</script>, <script type="math/tex">(N_A | N_{BB} )</script> are two one-way trading pairs in opposite directions, they are always fixed at one token in and the other token out. As the trades happening, the prices of the pair tokens always slide in opposite directions. After some trade volume accumulation, the price difference of the same token in the two sub-pools will exceed a certain level, which is too large to prevent users from participating the exchange. At this time, it is necessary to internally exchange the tokens between the sub-pools to smooth the token price difference. The process of internal token exchange within the sub-pools is actually a arbitrage process. Trading users conduct trade in two one-way trading pools, resulting token prices one-way slidding, and users will suffer trade losses from this price slippage. Through the internal exchange between two sub-pools, price slippage can be repaired, and the arbitrage to user trade slippage losses can be realized, which may make profits for the liquidity providers of the pool.</p>
<h3 id="24-freeswap-exchange-arbitrage">2.4 FreeSwap exchange arbitrage</h3>
<p>As said above, FreeSwap sets up two independent sub-trading pools:</p>
<p>
<script type="math/tex; mode=display">( N_{AA} | N_B )\ || \ ( N_A | N_{BB} ) \tag{2.4.1}</script>
</p>
<p>The prices of <script type="math/tex">Token A</script> and <script type="math/tex">Token B</script> in the two sub-pools will deviate as exchange occurs. When the price deviates to some extent, the two sub-pools need to internally exchange tokens to restore the token price. The token exchange between two sub-pools can restore the token prices of both side, and also realize arbitrage between the pools. The analysis following:</p>
<p>Before arbitrage, <script type="math/tex">Token A</script> prices in two pools are:</p>
<p>
<script type="math/tex; mode=display">P_{AA \rightarrow B} = \frac{N_B}{N_{AA}} \tag{2.4.2}</script>
</p>
<p>
<script type="math/tex; mode=display">P_{A \rightarrow {BB}} = \frac{N_{BB}}{N_A} \tag{2.4.3}</script>
</p>
<p>The deviation ratio is:</p>
<p>
<script type="math/tex; mode=display">R_{PA} = \frac{P_{A \rightarrow BB}}{P_{AA \rightarrow B}} = \frac{N_{AA} * N_{BB}}{N_B \ * \ N_A} \tag{2.4.4}</script>
</p>
<p>Similarly, <script type="math/tex">Token B</script> prices in the two pools are:</p>
<p>
<script type="math/tex; mode=display">P_{BB \rightarrow A} = \frac{N_A}{N_{BB}} \tag{2.4.5}</script>
</p>
<p>
<script type="math/tex; mode=display">P_{B \rightarrow {AA}} = \frac{N_{AA}}{N_B} \tag{2.4.6}</script>
</p>
<p>The deviation ratio is:</p>
<p>
<script type="math/tex; mode=display">R_{PB} = \frac{P_{B \rightarrow AA}}{P_{BB \rightarrow A}} = \frac{N_{AA} * N_{BB}}{N_B * N_A} \tag{2.4.7}</script>
</p>
<p>It can be seen that the price ratios of <script type="math/tex">Token A</script> and <script type="math/tex">Token B</script> in the two sub-pool are the same, namely:</p>
<p>
<script type="math/tex; mode=display">R_{PA} = R_{PB} = R_P = \frac{N_{AA} * N_{BB}}{N_B * N_A} \tag{2.4.8}</script>
</p>
<p>The FreeSwap protocol specifies that when the token prices of two sub-pool deviate to a certeain threshold <script type="math/tex">\gamma</script>, such as the value of <script type="math/tex">R_{P}</script> is greater such as 101%, the internal arbitrage exchange is automatically executed to restore the token price.</p>
<p>Arbitrage operation is to exchange one token with more amount in one sub-pool for the other token with more amount in the other sub-pool by equivalent value, that is, <script type="math/tex">(N_{AA}|N_B)</script> sub-pool swap <script type="math/tex">Token A</script> for <script type="math/tex">Token B</script> with same value in <script type="math/tex">(N_A|N_{BB})</script>. From another perspective, it is for <script type="math/tex">(N_A|N_{BB})</script> sub-pool to exchange <script type="math/tex">Token B</script> for <script type="math/tex">Token A</script> in <script type="math/tex">(N_{AA}|N_B )</script> sub-pool with equal value.</p>
<p>To ensure exchange fairness, the exchange price is set as the average price of all tokens in the two sub-pools, namely:</p>
<p>
<script type="math/tex; mode=display">P_{A \rightarrow B}^e = \frac{N_B + N_{BB}}{N_A + N_{AA}} \tag{2.4.9}</script>
</p>
<p>
<script type="math/tex; mode=display">P_{B \rightarrow A}^e = \ \frac{N_A + N_{AA}}{N_B + N_{BB}} \tag{2.4.10}</script>
</p>
<p>
<script type="math/tex; mode=display">P_{A \rightarrow B}^e * P_{B \rightarrow A}^e = \ 1 \tag{2.4.11}</script>
</p>
<p>After the arbitrage completed, the two sub-pools can be expressed as:</p>
<p>
<script type="math/tex; mode=display">(N_{AA} - L_A \ | \ N_B + L_B  )\ ||\ ( N_A + L_A \ | \ N_{BB} - L_B ) \tag{2.4.12}</script>
</p>
<p>That is, in this trade arbitrage, <script type="math/tex">A</script> pool exchanges <script type="math/tex">Token A</script> with a quantity of <script type="math/tex">L_A</script> for <script type="math/tex">Token B</script> with a quantity of <script type="math/tex">L_B</script>. Considering the exchange value is equal, the following equation exists:</p>
<p>
<script type="math/tex; mode=display">L_{B} = L_{A}*P_{A \rightarrow B}^e \tag{2.4.13}</script>
</p>
<p>After the arbitrage operation, <script type="math/tex">Token A</script> price of the <script type="math/tex">A</script> pool (priced in <script type="math/tex">Token B</script>) will increase, but it should not exceed the average price of the overall trading pool <script type="math/tex">P_{A \rightarrow B}^e</script> for the reason of fairness. Similarly, <script type="math/tex">Token B</script> price (priced in <script type="math/tex">Token A</script>) in <script type="math/tex">B</script> pool will also rise, but either should not exceed the average price <script type="math/tex">P_{B \rightarrow A}^e</script> , That is, the following relationship exists:</p>
<p>
<script type="math/tex; mode=display">\frac{N_B + L_B}{N_{AA} - L_A} \leq P_{A \rightarrow B}^e \tag{2.4.14} </script>
</p>
<p>
<script type="math/tex; mode=display">\frac{N_A \ + \ L_A}{N_{BB} \ - \ L_B} \normalsize \leq P_{B \rightarrow A}^e \tag{2.4.15}</script>
</p>
<p>Combining <script type="math/tex">(2.4.13)-(2.4.15)</script>, following relationships can be obtained: </p>
<p>
<script type="math/tex; mode=display">L_A \leq \frac{N_{AA}*N_{BB} - N_A*N_B}{2*(N_B + N_{BB})}  \tag{2.4.17} </script>
</p>
<p>
<script type="math/tex; mode=display">L_B \leq \frac{N_{AA}*N_{BB} - N_A*N_B}{2*(N_A + N_{AA})}  \tag{2.4.18} </script>
</p>
<p>In order to reduce the times of arbitrage operation, arbitrage between sub-pools should exchange as many tokens as possible to smooth token price deviations to the greatest extent. So <script type="math/tex">L_A</script>, <script type="math/tex">L_B</script> should take the maximum vaue given by <script type="math/tex">(2.4.17)</script> and <script type="math/tex">(2.4.18)</script>. It is easy to find, in this case, the token prices of the two sub-pool both happen to be restored to the average asset price of the whole trade pool <script type="math/tex">P_{A \rightarrow B}^e</script>, which is also the price at which the two sub-pools exchange tokens.</p>
<p>In general, Freeswap arbitrage can be expressed as follows:</p>
<p>
<script type="math/tex; mode=display">\left\{ \begin{aligned} 
\ \ &\frac{N_{AA} * N_{BB}}{N_A * N_B} \ \geq \ \gamma \\[3mm]
P_{A \rightarrow B}^e \ = \ \ &\frac{N_B + N_{BB}}{N_A + N_{AA}} \\[3mm]
L_A^e \ = \ \ &\frac{N_{AA}*N_{BB} - N_A*N_B}{2*(N_B + N_{BB})}  \\[3mm]
L_B^e \ = \ \ &\frac{N_{AA}*N_{BB} - N_A*N_B}{2*(N_A + N_{AA})}  \\[3mm]
\end{aligned} \right. \tag{2.4.19} </script>
</p>
<p>Among the above equation, <script type="math/tex">\gamma</script> is the condition for triggering the arbitrage operation, which means that arbitrage is executed when the price deviation of the two sub-pools is greater than or equal to <script type="math/tex">\gamma-1</script>. <script type="math/tex">L_A^e</script>, <script type="math/tex">L_B^e</script> are the amount of tokens exchanged between the two sub-pools within arbitrage operations. Arbitrage is taken by exchanging <script type="math/tex">L_A^e</script>, <script type="math/tex"> L_B^e</script> amount of <script type="math/tex">TokenA</script>, <script type="math/tex">Token B</script> at the price of <script type="math/tex">P_{A \rightarrow B}^e</script>, on arbitrage completion, the token prices of the two sub-pools are exactly the same, both are <script type="math/tex">P_{A \rightarrow B}^e</script>.</p>
<h2 id="3-freeswap-arbitrage-analysis">3 FreeSwap arbitrage analysis</h2>
<h3 id="31-freeswap-arbitrage-analysis">3.1 FreeSwap arbitrage analysis</h3>
<p>From the perspective of the liquidity provider, for the internal exchange of the two sub-pools, ie. arbitrage operations, following considerations should be taken:</p>
<p>1) Pool A and Pool B must both obtain positive returns in arbitrage operations. If one party gains and the other loses, the arbitrage mechanism cannot be established;</p>
<p>2) Pool A and Pool B both expect to maximize their profits in the arbitrage operations. The ideal goal of the arbitrage mechanism is to maximize the profits of both sub-pools simultaneously.</p>
<p>3) The arbitrage return of two sub-pools should be balanced reasonably. If one side gains more and the other side gains less, the arbitrage mechanism is also not perfect.</p>
<p>FreeSwap arbitrage protocol can meet the above three requirements, that is, it can realize the maximum positive profit for both sides of the trading pools, and the profits of both sides are equal.</p>
<p>The arbitrage profit can be measured by the changes of &ldquo;constant-product invariant&rdquo; of the sub-pool before and after the arbitrage operation. After the arbitrage completion, the changes in the <script type="math/tex">K</script> value of the two sub-pools are analyzed below.</p>
<p>For the <script type="math/tex">A</script> sub-pool, the change in K value after arbitrage is:</p>
<p>
<script type="math/tex; mode=display">\begin{aligned}
{{\Delta}K}_A &= ( N_{AA} - L_A ) * ( N_B + L_B ) - N_{AA} * N_B \\[1mm]
&= N_{AA} * L_B - L_A * N_B - L_A * L_B \\[1mm]
&= {-P}_{A \rightarrow B}^e * L_A^2 + ( N_{AA} * P_{A \rightarrow B}^e - N_B ) * L_A \\[1mm]
&= {-P}_{A \rightarrow B}^e * \left( L_A - \frac{N_{AA} - N_B * P_{B \rightarrow A}^e}{2} \right)^2 + \frac{( N_{AA} - N_B * P_{B \rightarrow A}^e )^2}{4*P_{B \rightarrow A}^e}
\end{aligned} \tag{3.1.1} </script>
</p>
<p>It can be seen that for <script type="math/tex">A</script> pool, while <script type="math/tex">L_A = L_A^M</script>, <script type="math/tex">K</script> value increases the most, that is, <script type="math/tex">A</script> pool gets the maximum arbitrage profit as:</p>
<p>
<script type="math/tex; mode=display">\begin{aligned}
L_A^M &= \frac{N_{AA} - N_B * P_{B \rightarrow A}^e}{2} \\[3mm]
&= \frac{N_{AA}*N_{BB} - N_A*N_B}{2*(N_B + N_{BB})} \\
\end{aligned} \tag{3.1.2} </script>
</p>
<p>It is obvious that <script type="math/tex">L_A^e</script> in <script type="math/tex">(2.4.19)</script> equals to <script type="math/tex">L_A^M</script>, it means that FreeSwap arbitrage mechanism can increase <script type="math/tex">K</script> value of the <script type="math/tex">A</script> pool to its maximum:</p>
<p>
<script type="math/tex; mode=display">\begin{aligned}
{{\Delta}K}_A^M &= \frac{( N_{AA} - N_B * P_{B \rightarrow A}^e )^2}{4*P_{B \rightarrow A}^e} \\[3mm]
&= \frac{(N_{AA}*N_{BB} - N_A *N_B)^2}{4*(N_A+N_{AA})*(N_B+N_{BB})}
\end{aligned} \tag{3.1.3} </script>
</p>
<p>Similarly, for the <script type="math/tex">B</script> sub-pool, the K value changes after arbitrage as follows:</p>
<p>
<script type="math/tex; mode=display">\begin{aligned}
{{\Delta}K}_B &= (N_{BB} - L_B) * (N_A + L_A) - N_{BB} * N_A \\[1mm]
&= N_{BB} * L_A - L_B * N_A - L_A * L_B \\[1mm]
&= {-P}_{B \rightarrow A}^e * L_B^2 + ( N_{BB} * P_{B \rightarrow A}^e - N_A ) * L_B \\[1mm]
&= {-P}_{B \rightarrow A}^e * \left( L_B - \frac{N_{BB} - N_A * P_{A \rightarrow B}^e}{2} \right)^2 + \frac{( N_{BB} - N_A * P_{A \rightarrow B}^e )^2}{4*P_{A \rightarrow B}^e} \end{aligned} \tag{3.1.4}</script>
</p>
<p>Similarly for the <script type="math/tex">B</script> pool, when <script type="math/tex">L_B = L_B^M</script>, the <script type="math/tex">K</script> value has the largest increase, that is, the <script type="math/tex">B</script> pool gets the maximum arbitrage profit:</p>
<p>
<script type="math/tex; mode=display">\begin{aligned}
L_B^M &= \frac{N_{BB} - N_A * P_{A \rightarrow B}^e}{2} \\[3mm]
&= \frac{N_{AA}*N_{BB} - N_A*N_B}{2*(N_A + N_{AA})} \\
\end{aligned} \tag{3.1.5} </script>
</p>
<p>Samely, <script type="math/tex">L_B^e</script> in <script type="math/tex">(2.4.19)</script> is equal to <script type="math/tex">L_B^M</script>, that is, FreeSwap arbitrage mechanism can increase <script type="math/tex">K</script> value of <script type="math/tex">B</script> pool to the maximum:</p>
<p>
<script type="math/tex; mode=display">\begin{aligned}
{{\Delta}K}_B^M &= \frac{( N_{BB} - N_A * P_{A \rightarrow B}^e)^2}{4*P_{A \rightarrow B}^e} \\[3mm]
&= \frac{(N_{AA}*N_{BB} - N_A *N_B)^2}{4*(N_A+N_{AA})*(N_B+N_{BB})}
\end{aligned} \tag{3.1.6} </script>
</p>
<p>Comparing <script type="math/tex">(3.1.3)</script>, <script type="math/tex">(3.1.6)</script> and <script type="math/tex">(2.4.19)</script>, we can see that:</p>
<p>
<script type="math/tex; mode=display">\Delta K_B^M \equiv \Delta K_A^M \equiv L_A^e*L_B^e \tag{3.1.7}</script>
</p>
<p>This means that FreeSwap arbitrage protocol can simultaneously maximize the increment of <script type="math/tex">K</script> Value both for the <script type="math/tex">A</script> pool and <script type="math/tex">B</script> pool by arbitrage, and the <script type="math/tex">K</script> value increment in the two sub-pool are exactly the same, which equals to the product of the amount of tokens internaly exchanged within arbitrage between the sub-pools.</p>
<h3 id="32-freeswap-arbitrage-profit">3.2 FreeSwap arbitrage profit</h3>
<p>To simplify the calculation, it is assumed that the Freeswap trading and arbitraging process is as follows:</p>
<p>1) The <script type="math/tex">A</script> pool and the <script type="math/tex">B</script> pool initially have the same amount of two tokens, which are represented by <script type="math/tex">X</script> and <script type="math/tex">Y</script> respectively;</p>
<p>2) In <script type="math/tex">A</script> pool, the user exchange <script type="math/tex">Token A</script> with a quantity of <script type="math/tex">x</script> for <script type="math/tex">TokenB</script> with a quantity of <script type="math/tex">y</script>, causing the token price of the <script type="math/tex">A</script> pool to slide. And the sliding range is <script type="math/tex">\gamma</script>, triggering arbitrage operation between <script type="math/tex">A</script> pool and <script type="math/tex">B</script> pool;</p>
<p>3) After arbitrage, the number of tokens in the <script type="math/tex">A</script> pool and the <script type="math/tex">B</script> pool becomes <script type="math/tex">(X+x'_1\ ,\ Y-y'_1)</script> and <script type="math/tex">(X+x'_2\ ,\ Y -y'_2)</script>；</p>
<p>The changes in the amount of <script type="math/tex">Tokens</script> during the trade and arbitrage process are shown in the following table:</p>
<p>
<script type="math/tex; mode=display">\begin{array}{lcc|c||c}
  Sub\ Pool: &  &  & A\ pool            & B\ Pool \\
  \hline
  Token\ State: &  &  & (N_{AA}\ ,\ N_B) & (N_A\ ,\ N_{BB}) \\
  \hline
  Initial\ State: &  &  & (X\ ,\ Y) & (X\ ,\ Y) \\
  \hline
  Post\ Trade： &  &  & (X + x\ ,\ Y - y)  & (X\ ,\ Y) \\
  \hline
  Post Arbitrage：&  &  & (X + x'_1\ ,\ Y - y'_1) & (X +  x'_2\ ,\ Y - y'_2) \\
  \hline
 \end{array}</script>
</p>
<p>According to the &ldquo;constant-product invariant&rdquo; formula, there are:</p>
<p>
<script type="math/tex; mode=display"> (X+x)*(Y-y) = X*Y </script>
</p>
<p>
<script type="math/tex; mode=display"> y = \frac{x}{X+x} * Y \tag{3.2.1} </script>
</p>
<p>According to the arbitrage triggering conditions in <script type="math/tex">(2.4.19)</script>, there are:</p>
<p>
<script type="math/tex; mode=display"> (X+x)*Y = \gamma * X* (Y-y) </script>
</p>
<p>
<script type="math/tex; mode=display"> x = (\sqrt{\gamma} -1 )* X \tag{3.2.2} </script>
</p>
<p>According to <script type="math/tex">(3.1.3)</script> and <script type="math/tex">(3.1.6)</script>, after arbitrage the maximum <script type="math/tex">K</script> value increasement of two sub-pools are:</p>
<p>
<script type="math/tex; mode=display">\begin{aligned}
\Delta K_A^M = \Delta K_B^M &= \frac{((X+x)*Y-X*(Y-y))^2}{4*(X+(X+x))*((Y-y)+Y)} \\[3mm]
&= \frac{(x*Y+y*X)^2}{4*(2X+x)*(2Y-y)} \\[3mm]
&= \frac{(\sqrt{\gamma}-1)^2}{4\sqrt{\gamma}}*X*Y 
\end{aligned} \tag{3.2.3} </script>
</p>
<p>After arbitrage, the increase ratio of <script type="math/tex">K</script> value both in <script type="math/tex">A</script> pool and <script type="math/tex">B</script> pool will be:</p>
<p>
<script type="math/tex; mode=display">\delta K_A = \delta K_B = \frac{(\sqrt{\gamma}-1)^2}{4\sqrt{\gamma}} \tag{3.2.4} </script>
</p>
<p>According to <script type="math/tex">(2.4.19)</script>, the amount of tokens exchanged between the two sub-pools during arbitrage operation can be calculated as follows:</p>
<p>
<script type="math/tex; mode=display"> L_A^e \ = \ \frac{\ x \ }{2} \tag{3.2.5}</script>
</p>
<p>
<script type="math/tex; mode=display">L_B^e \ = \ \frac{x}{2(X+x)} * Y = \ \frac{\ y \ }{2} \tag{3.2.6} </script>
</p>
<p>It can be seen that after arbitrage, the number of tokens in the two sub-pools becomes:</p>
<p>
<script type="math/tex; mode=display"> (X + \frac{\ x\ }{2}\ ,\ Y - \frac{\ y \ }{2} ) \  \ || \ \ (X + \frac{\ x\ }{2}\ ,\ Y - \frac{\ y \ }{2} ) \tag{3.2.7} </script>
</p>
<p>That is, the number of tokens in the two sub-pools is equal, achieving a complete balance.</p>
<p>The above analysis is based on the assumption that the amount of tokens in <script type="math/tex">A</script> pool and the <script type="math/tex">B</script> pool are exactly the same. Let’s analyze below, if the amount of tokens in <script type="math/tex">A</script> pool and the <script type="math/tex">B</script> pool are different, how much is the <script type="math/tex">K</script> value increase of the two sub-pools after arbitrage according to FreeSwap protocol. </p>
<p>In this case, the changes in the amount of tokens during the trade and arbitrage process are shown in the following table:</p>
<p>
<script type="math/tex; mode=display">\begin{array}{lccc||c}
  Sub-Pools：&  &  & A\ Pool            & B\ Pool \\
  \hline
  Token\ State: &  &  & (N_{AA}\ ,\ N_B) & (N_A\ ,\ N_{BB}) \\
  \hline
  Initial\ State: &  &  & (X_1\ ,\ Y_1) & (X_2\ ,\ Y_2) \\
  \hline
  Post\ Trade: &  &  & (X_1\ +\ x_1\ ,\ Y_1\ -\ y_1)  & (X_2\ ,\ Y_2) \\
  \hline
  Post Arbitrage：&  &  & (X_1\ +\ x_1'\ ,\ Y_1\ -\ y_1') & (X_2\ + \ x_2'\ ,\ Y_2\ - \ y_2') \\
  \hline
 \end{array}</script>
</p>
<p>Assuming that the <script type="math/tex">K</script> Value ratio of <script type="math/tex">A</script> pool and <script type="math/tex">B</script> pool is represented by <script type="math/tex">\beta</script>, the following relationship exists:</p>
<p>
<script type="math/tex; mode=display">\left\{ \begin{array}{ccl}
  &\Large \frac{Y_1}{X_1} \normalsize = \Large \frac{Y_2}{X_2}  & \small (Same\ Price)    \\[3mm]
  &\Large \frac{X_2*Y_2}{X_1*Y_1} \normalsize = \beta    &\small  (K\ Value\ ratio)  \\[3mm]
  &(X_1 + x_1) * (Y_1 - y_1) = X_1 * Y_1            &\small  (Constant\ Invariant)  \\[3mm]
  &(X_1 + x_1) * Y_2 = \gamma * X_2 * (Y_1 -y_1)    &\small  (Trigger\ Arbitrage)  \tag{3.2.8} \end{array} \right. </script>
</p>
<p>Jumping the dedcution process, it can be concluded that:</p>
<p>
<script type="math/tex; mode=display">\Delta K_A^M = \Delta K_B^M = \frac{(\gamma-1)^2}{4\gamma \Large (\normalsize\sqrt{\gamma} + \Large \frac{1}{\sqrt{\beta}})(\frac{1}{\sqrt{\gamma}} \normalsize + \Large \frac{1}{\sqrt{\beta}})} * X_1 * Y_1 
\tag{3.2.9} </script>
</p>
<p>So after arbitrage, the K value increase ratio of A pool and B pool are:</p>
<p>
<script type="math/tex; mode=display">\delta K_A = \frac{(\gamma-1)^2}{4\gamma \Large (\normalsize\sqrt{\gamma} + \Large \frac{1}{\sqrt{\beta}})(\frac{1}{\sqrt{\gamma}} \normalsize + \Large \frac{1}{\sqrt{\beta}})} \tag{3.2.10} </script>
</p>
<p>
<script type="math/tex; mode=display">\delta K_B = \frac{(\sqrt{\gamma}-1)^2}{\ \ 4\sqrt{\gamma}(\sqrt{\beta\gamma}+1)(\sqrt{\beta}+\sqrt{\gamma}) \ \ \ } \tag{3.2.11} </script>
</p>
<p>It can be seen from <script type="math/tex">(3.2.10)</script> and <script type="math/tex">(3.2.11)</script> that <script type="math/tex">\delta K_A</script> increases monotonically with <script type="math/tex">\beta</script>, while <script type="math/tex">\delta K_B</script> decreases monotonically with <script type="math/tex">\beta</script>, which means that when the amount of funds in the two sub-pools is unbalanced, the more the amount of tokens in the sub-pool relative to the other one, the less the increase in <script type="math/tex">K</script> value during arbitrage. On the contrary, the less the amount of tokens in the sub-pool, the more the increase in <script type="math/tex">K</script> value during arbitrage. Therefore, when users add liquidity, it is more advantageous to choose to join the sub-pool with smaller amount of tokens, and on the round it helps improve the liquidity of this smaller pool. This internal regulation mechanism of FreeSwap protocol can make the amount of tokens in the two sub-pools to keep in a dynamic balance.</p>
<h3 id="33-equivalent-transaction-fee-rate">3.3 Equivalent transaction fee rate</h3>
<p>If it is not through trading arbitrage, but by charging exchange fees, how to set the exchange fee rate to obtain the same <script type="math/tex">K</script> value increase as <script type="math/tex">(3.2.4)</script>?</p>
<p>Let&rsquo;s represen this trade fee rate as <script type="math/tex">\alpha</script>. Since the FreeSwap protocol has two independent one-way sub-pools, considering the equivalence, when calculating <script type="math/tex">\alpha</script>, the single two-way trade pool should have the same token amount, which can be expressed as: <script type="math/tex">(2X,2Y )</script>. The user exchanges <script type="math/tex">Token A</script> with the same amount of <script type="math/tex">x</script> as <script type="math/tex">(3.2.2)</script> for some amount of <script type="math/tex">Token B</script>, denoted by <script type="math/tex">y'</script>. According to the &ldquo;constant-product invariant&rdquo; formula, there are:</p>
<p>
<script type="math/tex; mode=display">(2X+(1-\alpha)x) * (2Y-y') = 2X*2Y \tag{3.3.1} </script>
</p>
<p>After the completion of the exchange, because the exchange fees do not participate in &ldquo;constant-product invariant&rdquo; calculation, just directly enter the liquidity pool, resulting in an increase in the <script type="math/tex">K</script> value of the overall token pool:</p>
<p>
<script type="math/tex; mode=display">\begin{aligned}
\Delta K &= \alpha x *(2Y-y') \\
&= ax * \frac{2X*2Y}{2X+(1-\alpha)x}
\end{aligned} \tag{3.3.2} </script>
</p>
<p>Compared with the <script type="math/tex">K</script> value before the exchange, the <script type="math/tex">K</script> Value increase of the whole pool is as follows:</p>
<p>
<script type="math/tex; mode=display">\delta K = \frac{ax}{2X+(1-\alpha)x} \tag{3.3.3}</script>
</p>
<p>Combining with <script type="math/tex">(3.2.2)</script>, <script type="math/tex">(3.2.4)</script>,  let <script type="math/tex">\delta K = \delta K_A</script>, we have:</p>
<p>
<script type="math/tex; mode=display">\alpha = \frac{\sqrt{\gamma}-1}{\sqrt{\gamma}+1} \tag{3.3.4}</script>
</p>
<p>As the calculation example, when <script type="math/tex">\gamma</script> = 1.01, <script type="math/tex">\alpha ≈</script> 2.488‰, that is, if the arbitrage is automatically conducted while the price deviation of the two sub-pools reaches 1%, the profit of the liquidity pool provider is equivalent to collect exchange fee of 2.488‰ from trading users. Currently, UniSwap <script type="math/tex">^{[2],[3]}</script> charges a exchange fee of 3‰ from trading users, so FreeSwap can achieve approximately 83% of UniSwap&rsquo;s profit rate through only exchange arbitrage. Taking into account that the FreeSwap protocol can provide users with totally free exchange, it can attract more exchange users and increase exchange volume. By the increase in exchange volume, it is possible for FreeSwap to achieve the same profit level as UniSwap, or even exceed UniSwap while completely waiving any exchange fees. </p>
<p>It can also be deduced from <script type="math/tex">(3.3.4) </script>
</p>
<p>
<script type="math/tex; mode=display">\sqrt{\gamma} = \frac{\ 1+\alpha \ }{1-\alpha} \tag{3.3.5}</script>
</p>
<p>According to the calculation, <script type="math/tex">\gamma ≈</script> 1.0121‰ while <script type="math/tex">\alpha</script> = 3‰,  that is, if FreeSwap performs arbitrage when the price deviation of the two sub-pools reaches 1.21%, it can obtain equivalent 3‰ of exchange fee income same as UniSwap.</p>
<h3 id="34-not-applicable-exchanges">3.4 Not applicable exchanges</h3>
<p>Since Freeswap protocol relies on exchange arbitrage when the price of sub-pools deviate to a certain level, Freeswap is not suitable for liquidity pools with both stable tokens exchanged. The exchange of stable tokens needs to minimize the price deviation as much as possible, it will not help attract exchange users by accumulating price deviation and then arbitraging.</p>
<p>Freeswap is also not applicable to exchange deflationary tokens. As intenal exchange will occur between two sub-pools for arbitrage, and the transfer of deflationary token will cause token deflation, which is not beneficial to the sub-pool swapping in deflationary token. Moreover, arbitrage will increase the transfer times of deflationary token, finally accelerate token deflation, this way violate the original intention of deflationary token.</p>
<h2 id="4-freeswap-protocol-conclusion">4 FreeSwap protocol conclusion</h2>
<p>Based on the &ldquo;constant-product invariant&rdquo; formula, freeswap creates two one-way exchange sub-pools for each pair of tokens. One-way exchange will cause the token prices of two sub-pools to slide in opposite direction. When the the price slippage reaches the preset threshold, the two-pools will exchange with each other internally and automatically for arbitrage. This arbitrage could provide revenue for the liquidity providers, and also smooth the price devation of two sub-pools.</p>
<p>The arbitrage mechanism of the FreeSwap protocol can maximize the profit for the two sub-pools at the same time, which ensures fairness and achieves a win-win situation. Calculations show that if arbitrage is performed when the price deviation of the sub-pool reaches 1%, FreeSwap&rsquo;s arbitrage mechanism can achieve the income equivalent to charge 2.488 ‰ of exchange fees while charging no fees at all.</p>
<p>By implementing a completely free decentralized exchange protocol，it is expected that FreeSwap can help attract more and more users to join in decentralized exchange and take part in more and more Defi activities. </p>
<h2 id="references">References</h2>
<p>1、Vitalik Buterin, <strong>Let&rsquo;s run on-chain decentralized exchanges the way we run prediction markets</strong>, Dec. 2016. URL: <a href="https://www.reddit.com/r/ethereum/comments/55m04x/lets_run_onchain_decentralized_exchanges_the_way">https://www.reddit.com/r/ethereum/comments/55m04x/lets_run_onchain_decentralized_exchanges_the_way</a>.</p>
<p>2、 Hayden Adams, <strong>Uniswap Whitepaper</strong>. URL: <a href="https://hackmd.io/C-DvwDSfSxuh-Gd4WKE_ig">https://hackmd.io/C-DvwDSfSxuh-Gd4WKE_ig</a>.</p>
<p>3、 Hayden Adams et al, <strong>Uniswap V2 Core</strong>. URL: <a href="https://uniswap.org/whitepaper.pdf">https://uniswap.org/whitepaper.pdf</a>.</p>
<p>4、 Vitalik Buterin, <strong>The x*y=k market maker model</strong>. URL: <a href="https://ethresear.ch/t/improving-front-running-resistance-of-x-y-k-market-makers">https://ethresear.ch/t/improving-front-running-resistance-of-x-y-k-market-makers</a>.</p>
<p>5、Pintail, <strong>Understanding Uniswap Returns</strong>. URL: <a href="https://medium.com/@pintail/understanding-uniswap-returns-cc593f3499ef">https://medium.com/@pintail/understanding-uniswap-returns-cc593f3499ef</a>.</p>
<p>6、Pintail, <strong>Uniswap: A Good Deal For Liquidity Providers?</strong>. URL: <a href="https://medium.com/@pintail/uniswap-a-good-deal-for-liquidity-providers-104c0b6816f2">https://medium.com/@pintail/uniswap-a-good-deal-for-liquidity-providers-104c0b6816f2</a>.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2020-2025 <a href= "mailto:ldru@163.com">ldru@163.com</a></p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
